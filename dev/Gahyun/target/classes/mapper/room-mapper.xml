<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gahyun.dev.mapper.RoomsMapper">
	
    <select id="findRoomDetailsWithPhotos" resultMap="roomDetailMap">
    	SELECT r.*, p.photo_id, p.photo_url  
    	FROM rooms r
    	LEFT JOIN room_photos p ON r.room_id = p.room_id
    	WHERE r.room_id = #{roomId}
    </select>
 	
 	<resultMap id="roomDetailMap" type="RoomDetailDto">
 		<id property="roomId" column="room_id"/>
 		<result property="roomName" column="room_name"/>
 		<result property="roomType" column="room_type"/>
 		<result property="pricePerNight" column="price_per_night"/>
 		<result property="capacity" column="capacity"/>
 		<result property="description" column="description"/>
 		<result property="createdAt" column="created_at"/>		
 		<collection property="photos" ofType="Room_PhotosDto">
 		<id property="photoId" column="photo_id"/>
 		<result property="photoUrl" column="photo_url"/>
 		</collection>
 	</resultMap>
 	
 	<resultMap id="roomsMap" type="RoomsDto">
 		<id property="roomId" column="room_id"/>
 		<result property="roomName" column="room_name"/>
 		<result property="roomType" column="room_type"/>
 		<result property="pricePerNight" column="price_per_night"/>
 		<result property="capacity" column="capacity"/>
 		<result property="description" column="description"/>
 		<result property="createdAt" column="created_at"/>		
 	</resultMap>
 	

	
	<select id="findAvailableRooms" resultMap="roomDetailMap">
	<![CDATA[      		
      	SELECT r.*, p.photo_id, p.photo_url
		FROM rooms r
		INNER JOIN room_photos p ON r.room_id = p.room_id
		LEFT JOIN reservations res ON r.room_id = res.room_id 
    		AND (res.check_in_date < #{endDate} AND res.check_out_date > #{startDate})
    		AND res.status = 'BOOKED' 
		WHERE r.capacity >= #{guestCount}
    		AND (res.room_id IS NULL
        	OR (res.status IS NULL OR res.status != 'BOOKED'))
	]]>
	</select>
  
</mapper>